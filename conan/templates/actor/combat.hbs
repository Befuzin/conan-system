{{!-- Combat Tab --}}
<div class="tab-content combat-tab" data-tab="combat">

  <div class="combat-grid">

    {{!-- Life Points (Characters and Antagonists) --}}
    {{#if (or (eq actor.type "character") (eq actor.type "antagonist"))}}
    <div class="stat-block life-points">
      <div class="stat-block-header">
        <h4><i class="fas fa-heart"></i> Life Points</h4>
      </div>
      <div class="stat-block-content">
        <div class="resource-bar">
          <input 
            type="number" 
            name="system.life.value" 
            value="{{system.life.value}}" 
            data-dtype="Number"
            placeholder="Current"
          />
          <span class="separator">/</span>
          <input 
            type="number" 
            name="system.life.max" 
            value="{{system.life.max}}" 
            data-dtype="Number"
            placeholder="Max"
          />
        </div>
        <div class="resource-visual">
          <div class="bar-fill life-bar" style="width: {{multiply (divide system.life.value system.life.max) 100}}%"></div>
        </div>
      </div>
    </div>
    {{/if}}

    {{!-- Threshold (Minions) --}}
    {{#if (eq actor.type "minion")}}
    <div class="stat-block threshold">
      <div class="stat-block-header">
        <h4><i class="fas fa-shield-alt"></i> Threshold</h4>
      </div>
      <div class="stat-block-content">
        <div class="threshold-info">
          <input 
            type="number" 
            name="system.threshold.value" 
            value="{{system.threshold.value}}" 
            data-dtype="Number"
          />
          <div class="threshold-status">
            {{#if system.isHit}}
            <span class="hit"><i class="fas fa-exclamation-triangle"></i> Hit Once</span>
            {{else}}
            <span class="unhit"><i class="fas fa-check-circle"></i> Unhit</span>
            {{/if}}
          </div>
        </div>
      </div>
    </div>
    {{/if}}

    {{!-- Stamina Points (Characters) --}}
    {{#if (eq actor.type "character")}}
    <div class="stat-block stamina-points">
      <div class="stat-block-header">
        <h4><i class="fas fa-bolt"></i> Stamina Points</h4>
      </div>
      <div class="stat-block-content">
        <div class="resource-bar">
          <input 
            type="number" 
            name="system.stamina.value" 
            value="{{system.stamina.value}}" 
            data-dtype="Number"
            placeholder="Current"
          />
          <span class="separator">/</span>
          <div class="stamina-max">{{system.stats.grit.value}}</div>
        </div>
        <div class="stamina-controls">
          <button 
            class="stamina-adjust minus" 
            data-action="adjustStamina"
            data-delta="-1"
            type="button"
            title="Decrease"
          >
            <i class="fas fa-minus"></i>
          </button>
          <button 
            class="stamina-adjust plus" 
            data-action="adjustStamina"
            data-delta="1"
            type="button"
            title="Increase"
          >
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </div>
    </div>

    {{!-- Flex Die --}}
    <div class="stat-block flex-die">
      <div class="stat-block-header">
        <h4><i class="fas fa-star"></i> Flex Die</h4>
      </div>
      <div class="stat-block-content">
        <select name="system.flex.die" data-dtype="String">
          {{#select system.flex.die}}
          {{#each config.flexDice as |label value|}}
          <option value="{{value}}">{{label}}</option>
          {{/each}}
          {{/select}}
        </select>
        <div class="flex-info">
          <i class="fas fa-info-circle"></i>
          <span class="tooltip">Triggers on max roll ({{getMaxDie system.flex.die}})</span>
        </div>
      </div>
    </div>

    {{!-- Recoveries --}}
    <div class="stat-block recoveries">
      <div class="stat-block-header">
        <h4><i class="fas fa-medkit"></i> Recoveries</h4>
      </div>
      <div class="stat-block-content">
        <div class="recovery-tracker">
          {{#times system.recoveries.max}}
          <div class="recovery-pip {{#if (lt @index ../system.recoveries.value)}}available{{else}}used{{/if}}">
            <i class="fas fa-heart"></i>
          </div>
          {{/times}}
        </div>
        <button 
          class="use-recovery" 
          data-action="useRecovery"
          type="button"
          {{#unless (gt system.recoveries.value 0)}}disabled{{/unless}}
        >
          <i class="fas fa-medkit"></i> Use Recovery
        </button>
      </div>
    </div>
    {{/if}}

    {{!-- Defenses --}}
    <div class="stat-block defenses">
      <div class="stat-block-header">
        <h4><i class="fas fa-shield"></i> Defenses</h4>
      </div>
      <div class="stat-block-content defense-grid">
        
        {{!-- Physical Defense --}}
        <div class="defense-item">
          <label>Physical Defense</label>
          <div class="defense-calculation">
            <input 
              type="number" 
              name="system.defense.physical.base" 
              value="{{system.defense.physical.base}}" 
              data-dtype="Number"
              placeholder="Base"
              title="Base Defense"
            />
            <span>+</span>
            <div class="defense-bonus">
              <button 
                data-action="adjustBonus"
                data-field="defense.physical"
                data-delta="-1"
                type="button"
                title="Decrease"
              >
                <i class="fas fa-minus"></i>
              </button>
              <span class="bonus-value">{{numberFormat system.defense.physical.bonus decimals=0 sign=true}}</span>
              <button 
                data-action="adjustBonus"
                data-field="defense.physical"
                data-delta="1"
                type="button"
                title="Increase"
              >
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <span>=</span>
            <div class="defense-total">
              {{add system.defense.physical.base system.defense.physical.bonus}}
            </div>
          </div>
        </div>

        {{!-- Sorcery Defense --}}
        <div class="defense-item">
          <label>Sorcery Defense</label>
          <div class="defense-calculation">
            <input 
              type="number" 
              name="system.defense.sorcery.base" 
              value="{{system.defense.sorcery.base}}" 
              data-dtype="Number"
              placeholder="Base"
              title="Base Defense"
            />
            <span>+</span>
            <div class="defense-bonus">
              <button 
                data-action="adjustBonus"
                data-field="defense.sorcery"
                data-delta="-1"
                type="button"
                title="Decrease"
              >
                <i class="fas fa-minus"></i>
              </button>
              <span class="bonus-value">{{numberFormat system.defense.sorcery.bonus decimals=0 sign=true}}</span>
              <button 
                data-action="adjustBonus"
                data-field="defense.sorcery"
                data-delta="1"
                type="button"
                title="Increase"
              >
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <span>=</span>
            <div class="defense-total">
              {{add system.defense.sorcery.base system.defense.sorcery.bonus}}
            </div>
          </div>
        </div>

      </div>
    </div>

    {{!-- Armor Rating (Minions and Antagonists) --}}
    {{#unless (eq actor.type "character")}}
    <div class="stat-block armor-rating">
      <div class="stat-block-header">
        <h4><i class="fas fa-vest"></i> Armor Rating (AR)</h4>
      </div>
      <div class="stat-block-content">
        <div class="ar-range">
          <input 
            type="number" 
            name="system.ar.min" 
            value="{{system.ar.min}}" 
            data-dtype="Number"
            placeholder="Min"
          />
          <span>-</span>
          <input 
            type="number" 
            name="system.ar.max" 
            value="{{system.ar.max}}" 
            data-dtype="Number"
            placeholder="Max"
          />
        </div>
      </div>
    </div>
    {{/unless}}

    {{!-- Apply Damage Button --}}
    <div class="stat-block damage-control">
      <div class="stat-block-header">
        <h4><i class="fas fa-syringe"></i> Damage</h4>
      </div>
      <div class="stat-block-content">
        <button 
          class="apply-damage"
          data-action="applyDamage"
          type="button"
        >
          <i class="fas fa-heartbeat"></i> Apply Damage
        </button>
      </div>
    </div>

  </div>

</div>
